pragma solidity ^0.8.0;

import "forge-std/Script.sol";
import "src/Kernel.sol";
import "forge-std/console.sol";

import "src/factory/FactoryStaker.sol";
import "src/factory/KernelFactory.sol";

bytes constant KERNEL_CODE =
    hex"0000000000000000000000000000000000000000000000000000000000000000610140346101fd57601f61538438819003918201601f191683019291906001600160401b038411838510176102025781602092849260409687528339810103126101fd57516001600160a01b03811681036101fd57306080524660a05260a0825161006981610218565b600681526005602082016512d95c9b995b60d21b81526020865161008c81610218565b838152019264302e332e3160d81b845251902091208160c0528060e0528451917f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f835260208301528482015246606082015230608082015220916101009283526101209182528051602081019063deadbeef60e01b82526004815261011081610218565b5190516001600160581b0319918282169190601581106101e8575b505090507f7bcaa2ced2a71450ed5a9a1b4848e8e5206dbc3f06011e595f7f55428cc6f84f9060581c60018060a81b03198254161790555190615150928361023484396080518361427d015260a051836142a0015260c05183614312015260e051836143380152518261425c01525181818161050301528181610827015281816109dd01528181610d74015281816110d901528181611241015281816112a1015281816117c901528181611938015281816121d7015261299b0152f35b8391925060150360031b1b161680388061012b565b600080fd5b634e487b7160e01b600052604160045260246000fd5b604081019081106001600160401b038211176102025760405256fe6080604052600436101561001d575b366129485761001b612917565b005b60003560e01c8063112d3a7d146101ed57806312af322c146101e8578063150b7a02146101e35780631626ba7e146101de57806319822f7c146101d95780631f1b92e3146101d45780633659cfe6146101cf57806357b3a5f4146101ca5780636e6fa0c6146101c5578063721e67f4146101c057806384b0196e146101bb5780638dd7712f146101b657806390ef8862146101b15780639198bdf5146101ac5780639517e29f146101a75780639cfd7cff146101a2578063a65d69d41461019d578063a71763a814610198578063adb610a314610193578063b8afe17d1461018e578063bc197c8114610189578063c3e5897814610184578063d03c79141461017f578063d691c9641461017a578063e6f3d50a14610175578063e9ae5c5314610170578063f1f7f0f91461016b578063f23a6e61146101665763f2dc691d0361000e57611ac5565b611a6b565b611a33565b611907565b61174e565b61166a565b61161d565b611541565b61143a565b6113d0565b61139c565b611270565b61122b565b6111d4565b6110a8565b610fa1565b610e50565b610d3f565b610c9d565b610bf1565b610b94565b610ae6565b61099d565b6107e5565b6104c5565b610465565b61040b565b6102b9565b610281565b6001600160a01b0381160361020357565b600080fd5b3590610213826101f2565b565b9181601f84011215610203578235916001600160401b038311610203576020838186019501011161020357565b6060600319820112610203576004359160243561025e816101f2565b91604435906001600160401b0382116102035761027d91600401610215565b9091565b3461020357602061029d61029436610242565b92919091611cc5565b6040519015158152f35b6001600160581b031981160361020357565b34610203576080366003190112610203576004356102d6816102a7565b6024356102e2816101f2565b6001600160401b039060443582811161020357610303903690600401610215565b90926064359081116102035761031d903690600401610215565b9390926001600160581b031961035d816103566103496000805160206151308339815191525460581b90565b6001600160581b03191690565b1615611d8f565b8616156103f9576001600160f81b03198616600160f81b81141590816103ea575b506103d8578561039061001b97612ad8565b6103b061039b610f70565b60018152926001600160a01b03166020840152565b600080516020615130833981519152805463ffffffff60a81b1916600160a81b179055612b33565b6040516361c4e91b60e11b8152600490fd5b600160f91b141590503861037e565b604051631a0a9b9f60e21b8152600490fd5b34610203576080366003190112610203576104276004356101f2565b6104326024356101f2565b6064356001600160401b03811161020357610451903690600401610215565b5050604051630a85bd0160e11b8152602090f35b34610203576040366003190112610203576024356001600160401b038111610203576104a361049a6020923690600401610215565b90600435611eaa565b6040516001600160e01b03199091168152f35b90816101209103126102035790565b606036600319011261020357600480356001600160401b038111610203576104f090369083016104b6565b60243590604435906001600160a01b03907f0000000000000000000000000000000000000000000000000000000000000000821633036107b05780849261053a6020830135612e9f565b6001600160f81b031990911615959093909186610786575b908461055e9392613084565b9561057061056b84611c53565b611fd7565b9415948580610744575b61073357602001516001600160a01b0316918216908115610722576001926105af6105ce926000526000602052604060002090565b80546001600160a01b0319166001600160a01b03909216919091179055565b036106815782610623575b5050610612576105fc9250805b610600575b506040519081529081906020820190565b0390f35b3490349034903490335af150386105eb565b604051631a0a9b9f60e21b81528390fd5b61067a92506106769161065861065261064c61064161066f95611c8c565b936060810190612003565b90611af4565b90611c27565b63ffffffff60e01b16600052602052604060002090565b5460ff1690565b1590565b38806105d9565b829192916106ef575b506106de5761064c8160606106a0930190612003565b638dd7712f60e01b916001600160e01b0319916106bc91611c27565b16036106cd576105fc9250806105e6565b60405163dbbb044b60e01b81528390fd5b604051631a0a9b9f60e21b81528490fd5b61071c915061066f61070361067692611c8c565b6106586106526107166060880188612003565b90611ae3565b3861068a565b604051631a0a9b9f60e21b81528990fd5b604051633ab3447f60e11b81528990fd5b50805163ffffffff1663ffffffff61077e6107756000805160206151308339815191525463ffffffff9060c81c1690565b63ffffffff1690565b91161061057a565b93509061055e916107a66000805160206151308339815191525460581b90565b9490919250610552565b6040516348f5c3ed60e01b81528590fd5b6004359063ffffffff8216820361020357565b359063ffffffff8216820361020357565b6020366003190112610203576107f96107c1565b61081b6108156000805160206151308339815191525460581b90565b60581c90565b6001600160a01b0390337f00000000000000000000000000000000000000000000000000000000000000008316141580610993575b156109885760405163ecd0596160e01b8152600480820152911690602081602481855afa90811561091957600091610959575b50156109475760405163d68f602560e01b815291600083806108aa363433600485016120c6565b038183865af19283156109195760009361091e575b506108c99061322b565b803b1561020357604051630b9dfbed60e11b81529160009183918290849082906108f69060048301612102565b03925af180156109195761090657005b8061091361001b92610eca565b80610c4a565b611e9e565b6108c9919350610940903d806000833e6109388183610f4f565b810190612068565b92906108bf565b6040516348f5c3ed60e01b8152600490fd5b61097b915060203d602011610981575b6109738183610f4f565b810190612035565b38610883565b503d610969565b505061001b9061322b565b5030331415610850565b6020366003190112610203576004356109b5816101f2565b6109d16108156000805160206151308339815191525460581b90565b6001600160a01b0390337f00000000000000000000000000000000000000000000000000000000000000008316141580610aca575b15610abf5760405163ecd0596160e01b8152600480820152911690602081602481855afa90811561091957600091610aa0575b50156109475760405163d68f602560e01b81529160008380610a60363433600485016120c6565b038183865af192831561091957600093610a7f575b506108c990612113565b6108c9919350610a99903d806000833e6109388183610f4f565b9290610a75565b610ab9915060203d602011610981576109738183610f4f565b38610a39565b505061001b90612113565b5030331415610a06565b6001600160e01b031981160361020357565b34610203576020366003190112610203576105fc610b28600435610b0981610ad4565b600060408051610b1881610ee2565b8281528260208201520152611dd1565b60405190610b3582610ee2565b80546001600160a01b0390811680845260019092015480821660208086019182526001600160f81b031960589390931b831660409687019081528651958652915190931692840192909252905116918101919091529081906060820190565b3461020357604036600319011261020357602060ff610be5600435610bb8816102a7565b610bcd60243591610bc883610ad4565b611c8c565b9063ffffffff60e01b16600052602052604060002090565b54166040519015158152f35b34610203576020366003190112610203576020610c27600435610c13816101f2565b6000604051610c2181610efd565b52612ab1565b60405190610c3482610efd565b546001600160a01b031690819052604051908152f35b600091031261020357565b60005b838110610c685750506000910152565b8181015183820152602001610c58565b90602091610c9181518092818552858086019101610c55565b601f01601f1916010190565b3461020357600036600319011261020357610cec610cb961330b565b90604051928392600f60f81b8452610cde60209360e0602087015260e0860190610c78565b908482036040860152610c78565b90466060840152306080840152600060a084015282820360c0840152602060605192838152019160809160005b828110610d2857505050500390f35b835185528695509381019392810192600101610d19565b6040366003190112610203576004356001600160401b03811161020357610d6a9036906004016104b6565b6001600160a01b037f000000000000000000000000000000000000000000000000000000000000000081163303610947576060906001610dc6610db96024356000526000602052604060002090565b546001600160a01b031690565b91821614159283610e20575b610ded610de6826060610df4940190612003565b8091611b02565b9030613452565b509215610e055761001b9250613479565b505015610e0e57005b60405163f21e646b60e01b8152600490fd5b9150610df4610ded610de6610e46610e3e610de66060880188612003565b9034876133d0565b9492505050610dd2565b3461020357600036600319011261020357602063ffffffff6000805160206151308339815191525460c81c16604051908152f35b9181601f84011215610203578235916001600160401b038311610203576020808501948460051b01011161020357565b634e487b7160e01b600052604160045260246000fd5b6001600160401b038111610edd57604052565b610eb4565b606081019081106001600160401b03821117610edd57604052565b602081019081106001600160401b03821117610edd57604052565b604081019081106001600160401b03821117610edd57604052565b61012081019081106001600160401b03821117610edd57604052565b90601f801991011681019081106001600160401b03821117610edd57604052565b6040519061021382610f18565b6040519061021382610f33565b6001600160401b038111610edd5760051b60200190565b6080366003190112610203576001600160401b0360043581811161020357610fcd903690600401610e84565b906024358381116102035736602382011215610203578060040135610ff181610f8a565b916040916110026040519485610f4f565b8084526020906024602086019160061b8401019236841161020357602401905b83821061106a57505050505060443584811161020357611046903690600401610e84565b916064359586116102035761106261001b963690600401610e84565b9590946121a8565b848236031261020357828591825161108181610f18565b61108a856107d4565b815282850135611099816101f2565b83820152815201910190611022565b6110b136610242565b6110cd6108156000805160206151308339815191525460581b90565b6001600160a01b0390337f000000000000000000000000000000000000000000000000000000000000000083161415806111ca575b156111be5760405163ecd0596160e01b815260048082015291169290602081602481875afa9081156109195760009161119f575b50156109475760405163d68f602560e01b8152936000858061115d363433600485016120c6565b038183885af19485156109195760009561117e575b506108c9939495612364565b6108c9949550611198903d806000833e6109388183610f4f565b9493611172565b6111b8915060203d602011610981576109738183610f4f565b38611136565b50509161001b93612364565b5030331415611102565b34610203576000366003190112610203576105fc6040516111f481610f18565b60168152756b65726e656c2e616476616e6365642e76302e332e3160501b6020820152604051918291602083526020830190610c78565b34610203576000366003190112610203576040517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b61127936610242565b6112956108156000805160206151308339815191525460581b90565b6001600160a01b0390337f00000000000000000000000000000000000000000000000000000000000000008316141580611392575b156113865760405163ecd0596160e01b815260048082015291169290602081602481875afa90811561091957600091611367575b50156109475760405163d68f602560e01b81529360008580611325363433600485016120c6565b038183885af194851561091957600095611346575b506108c9939495612673565b6108c9949550611360903d806000833e6109388183610f4f565b949361133a565b611380915060203d602011610981576109738183610f4f565b386112fe565b50509161001b93612673565b50303314156112ca565b3461020357600036600319011261020357602063ffffffff6000805160206151308339815191525460a81c16604051908152f35b346102035760203660031901126102035760406114006004356113f2816102a7565b6113fa61280f565b50611c53565b602082519161140e83610f18565b5463ffffffff81169283815260018060a01b03928391019160201c168152835192835251166020820152f35b346102035760a0366003190112610203576114566004356101f2565b6114616024356101f2565b6001600160401b0360443581811161020357611481903690600401610e84565b50506064358181116102035761149b903690600401610e84565b5050608435908111610203576114b5903690600401610215565b505060405163bc197c8160e01b8152602090f35b602080825282516001600160f01b03191681830152808301516001600160a01b03166040808401919091529092015160608083015280516080830181905260a090920192908101919060005b828110611523575050505090565b83516001600160501b03191685529381019392810192600101611515565b34610203576020806003193601126102035760043561155f81610ad4565b611584604091606083805161157381610ee2565b600081526000878201520152611e09565b9080519161159183610ee2565b805460f081901b6001600160f01b031916845260101c6001600160a01b031684840152815160019182018054808352600091825286822083880197939490939092905b8282106115fb576105fc8888886115ed818e0382610f4f565b8183015251918291826114c9565b845460501b6001600160501b03191689529788019793830193908301906115d4565b3461020357602036600319011261020357602061029d600435612828565b9060406003198301126102035760043591602435906001600160401b0382116102035761027d91600401610215565b6116733661163b565b916001600160a01b0361168533612ab1565b541690811561173c57606060019460018414159485611725575b6116a99293613b3c565b92611715575b5050906040519060208083016020845284518091526040840191602060408360051b8701019601926000905b8382106116e85786880387f35b90919293948380611704839a603f198b82030186528951610c78565b9997019594939190910191016116db565b61171e91613479565b38806116af565b6116a9925061173536348761334c565b925061169f565b60405163710c949760e01b8152600490fd5b6060366003190112610203576004803590611768826102a7565b6001600160401b0391602435838111610203576117889036908401610215565b93604435908111610203576117a09036908501610215565b906117bd6108156000805160206151308339815191525460581b90565b6001600160a01b0390337f000000000000000000000000000000000000000000000000000000000000000083161415806118fd575b156118ed57169560405163ecd0596160e01b81526020818061181b8a8201906004602083019252565b03818b5afa908115610919576000916118ce575b50156118bd5760405163d68f602560e01b815293600085806118553634338d85016120c6565b0381838c5af19485156109195760009561189e575b5061187594956128ea565b823b15610203576108f69260009283604051809681958294630b9dfbed60e11b84528301612102565b61187595506118b7903d806000833e6109388183610f4f565b9461186a565b6040516348f5c3ed60e01b81528690fd5b6118e7915060203d602011610981576109738183610f4f565b3861182f565b50509261001b95929194506128ea565b50303314156117f2565b6119103661163b565b61192c6108156000805160206151308339815191525460581b90565b6001600160a01b0390337f00000000000000000000000000000000000000000000000000000000000000008316141580611a29575b15611a1d5760405163ecd0596160e01b815260048082015291169190602081602481865afa908115610919576000916119fe575b50156109475760405163d68f602560e01b815292600084806119bc363433600485016120c6565b038183875af1938415610919576000946119dd575b506108c99293946128ff565b6108c99394506119f7903d806000833e6109388183610f4f565b93926119d1565b611a17915060203d602011610981576109738183610f4f565b38611995565b50509061001b926128ff565b5030331415611961565b346102035760003660031901126102035760206000805160206151308339815191525460581b604051906001600160581b0319168152f35b346102035760a036600319011261020357611a876004356101f2565b611a926024356101f2565b6084356001600160401b03811161020357611ab1903690600401610215565b505060405163f23a6e6160e01b8152602090f35b3461020357602036600319011261020357602061029d60043561290a565b906008116102035760040190600490565b906004116102035790600490565b909291928360041161020357831161020357600401916003190190565b906018116102035760040190601490565b906014116102035790601490565b906020116102035790602090565b909291928360011161020357831161020357600101916000190190565b909291928360141161020357831161020357601401916013190190565b906016116102035790601690565b906016116102035760020190601490565b909291928360161161020357831161020357601601916015190190565b906002116102035790600290565b906009116102035760010190600890565b909291928360091161020357831161020357600901916008190190565b90602c116102035760180190601490565b90939293848311610203578411610203578101920390565b6001600160e01b03199035818116939260048110611c4457505050565b60040360031b82901b16169150565b6001600160581b0319166000527f7bcaa2ced2a71450ed5a9a1b4848e8e5206dbc3f06011e595f7f55428cc6f850602052604060002090565b6001600160581b0319166000527f7bcaa2ced2a71450ed5a9a1b4848e8e5206dbc3f06011e595f7f55428cc6f851602052604060002090565b90929060018103611d1457506001600160a01b0392611d0e9250611cfe915060581b600160581b600160f81b0316600160f81b17611c53565b5460201c6001600160a01b031690565b16151590565b60028103611d4757506001600160a01b0392611d0e9250611d3b9150610db9908416612ab1565b6001600160a01b031690565b600303611d8757611d68611d63610652600193611d7695611af4565b611dd1565b01546001600160a01b031690565b6001600160a01b0390811691161490565b505050600090565b15611d9657565b60405162461bcd60e51b8152602060048201526013602482015272185b1c9958591e481a5b9a5d1a585b1a5e9959606a1b6044820152606490fd5b63ffffffff60e01b166000527f7c341349a4360fdd5d5bc07e69f325dc6aaea3eb018b3e0ea7e53cc0bb0d6f3b602052604060002090565b63ffffffff60e01b166000527f7bcaa2ced2a71450ed5a9a1b4848e8e5206dbc3f06011e595f7f55428cc6f852602052604060002090565b908160209103126102035751611e5681610ad4565b90565b908060209392818452848401376000828201840152601f01601f1916010190565b611e56949260609260018060a01b0316825260208201528160408201520191611e59565b6040513d6000823e3d90fd5b91611eb491612d24565b91906001600160f81b031980831615611fb6575b6001600160a01b039081611ee1611d3b611cfe87611c53565b16156103f9578316600160f81b03611f6657906020939291611f05611f2396612e56565b604051637aa8f17760e11b8152968795869485933360048601611e7a565b039260581c165afa90811561091957600091611f3d575090565b611e56915060203d602011611f5f575b611f578183610f4f565b810190611e41565b503d611f4d565b509060081b92600160f11b611f94611f87611f8087611e09565b5460f01b90565b6001600160f01b03191690565b16611fa457611e56933390612da5565b604051635b71057960e01b8152600490fd5b9150611fd16000805160206151308339815191525460581b90565b91611ec8565b90604051611fe481610f18565b915463ffffffff81168352602090811c6001600160a01b031690830152565b903590601e198136030182121561020357018035906001600160401b0382116102035760200191813603831361020357565b90816020910312610203575180151581036102035790565b6001600160401b038111610edd57601f01601f191660200190565b602081830312610203578051906001600160401b038211610203570181601f8201121561020357805161209a8161204d565b926120a86040519485610f4f565b8184526020828401011161020357611e569160208085019101610c55565b916080939160018060a01b03168352602083015260606040830152806060830152806000848401376000828201840152601f01601f1916010190565b906020611e56928181520190610c78565b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc8190556001600160a01b03167fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b600080a2565b9060405161217481610ee2565b82546001600160a01b039081168252600190930154928316602082015260589290921b6001600160f81b0319166040830152565b959294919390946121cb6108156000805160206151308339815191525460581b90565b6001600160a01b0390337f00000000000000000000000000000000000000000000000000000000000000008316141580612318575b156123085760405163ecd0596160e01b8152600480820152911695906020816024818a5afa908115610919576000916122e9575b50156109475760405163d68f602560e01b8152966000888061225b363433600485016120c6565b0381838b5af1978815610919576000986122c8575b5061227c969798613524565b803b1561020357604051630b9dfbed60e11b81529160009183918290849082906122a99060048301612102565b03925af18015610919576122bb575b50565b8061091361021392610eca565b61227c9798506122e2903d806000833e6109388183610f4f565b9796612270565b612302915060203d602011610981576109738183610f4f565b38612234565b5050919390929461021396613524565b5030331415612200565b916020611e56938181520191611e59565b6bffffffffffffffffffffffff19903581811693926014811061235557505050565b60140360031b82901b16169150565b6001810361244057506106526102139361242c61243a93600160581b600160f81b039060581b16600160f81b17946123fb6123d4611d3b6123ce6123c86123c16000805160206151308339815191525463ffffffff9060a81c1690565b9786611b30565b90612333565b60601c90565b6123eb6123df610f70565b63ffffffff9096168652565b6001600160a01b03166020850152565b6014810135810192603482013582019160548101350193603460148401359301916034601483013592019089612b33565b603460148201359101611af4565b90613838565b6002810361249c57509161248d61021393612472611d3b6123ce6123c860148801358801966034890135890198611b30565b928391601482013591603401906001600160a01b03166137aa565b603460148301359201906136dd565b9091906003810361251c5750612517611d3b612507610213958461250260186123ce97013582016123ce60388401358401996124db6106528787611af4565b906124fc611d3b6124ec8989611b1f565b6018880135976038019691612333565b91613592565b611b1f565b6018860135956038019491612333565b6136dd565b9091906004810361255d57506001600160a01b031691823b15610203576122a992600092836040518096819582946306d61fe760e41b845260048401612322565b6005810361259b57506001600160a01b031691823b15610203576122a992600092836040518096819582946306d61fe760e41b845260048401612322565b6006036125d7576001600160a01b031691823b15610203576122a992600092836040518096819582946306d61fe760e41b845260048401612322565b604051631092ef5760e11b8152600490fd5b604051906125f682610efd565b60008252565b35906020811061260a575090565b6000199060200360031b1b1690565b91906040519061262882610efd565b819360008352116102035760206000910152565b9291926126488261204d565b916126566040519384610f4f565b829481845281830111610203578281602093846000960137010152565b9291906001840361269d576122b8935060581b600160581b600160f81b0316600160f81b176139f0565b600284036126b8576122b893506001600160a01b03166139a6565b909190600384036126e757506122b8925080806126db6106526126e19486611af4565b93611b02565b9161394c565b91926004810361276d57506122b89261273a916127136000805160206151308339815191525460581b90565b61271f611cfe82611c53565b6001600160a01b03868116911614612740575b50369161263c565b9061389d565b61274c61276791611c53565b8054640100000000600160c01b031916640100000000179055565b38612732565b600581036127f057506000805160206151308339815191525460581b5b61279d6127978386611b3e565b906125fc565b906001600160f81b03198116600160f91b146127c5575b50506122b89261273a91369161263c565b60081b6001600160e01b031916146127de5738806127b4565b6040516313002bdd60e31b8152600490fd5b6006036125d7576000805160206151308339815191525460581b61278a565b6040519061281c82610f18565b60006020838281520152565b61283c818060081b918160301b9160501b90565b929091600160f81b916001600160f81b0319919082168381141590816128e0575b816128d5575b816128c6575b506128bc57169081141590816128b2575b506128ab576001600160e01b0319166128a5576001600160501b0319166128a057600190565b600090565b50600090565b5050600090565b905015153861287a565b5050505050600090565b607f60f91b1415905038612869565b838114159150612863565b801515915061285d565b916128fa916102139594936139f0565b613d41565b906122b89291613b3c565b600711156128a057600190565b7f88a5966d370b9919b20f3e2c13ff65706f196a4e32cc2c12bf57088f8852587460408051338152346020820152a1565b6129656129606000356001600160e01b031916611dd1565b612167565b80516001600160a01b039081169190828061298c57604051631cd4b64760e21b8152600490fd5b606093828103612a8d575050807f0000000000000000000000000000000000000000000000000000000000000000163303610947575b60408201516001600160f81b031990811680612a505750506020820151612a0793906129f6906001600160a01b0316613d9e565b9490935b516001600160a01b031690565b918083169060018214159182612a45575b5050612a35575b5050612a2d57602081519101fd5b602081519101f35b612a3e91613479565b3880612a1f565b141590503880612a18565b03612a7b576020820151612a079390612a73906001600160a01b0316369061342b565b9490936129fa565b604051632d6a6bb760e01b8152600490fd5b600103612a9b575b506129c2565b612aaa9193503690349061334c565b9138612a95565b6001600160a01b031660009081526000805160206151108339815191526020526040902090565b60207f6789ec0c85d6458d897a36a70129b101f8b4d84c6e218046c3107373dbcbae88916000805160206151308339815191528160581c6001600160581b0360a81b825416179055604051906001600160581b0319168152a1565b9193909294612b4e612b4484611c53565b5463ffffffff1690565b9360008051602061513083398151915294612b71865463ffffffff9060a81c1690565b63ffffffff809281808416911614612ce6575b50506020820180516001600160a01b0397919291612bb191891615612cdd575b5460a81c63ffffffff1690565b81612bc3610775865163ffffffff1690565b91161490811591612cb3575b50612ca1576129fa612c1e92612be487611c53565b815181546020938401516001600160c01b031990911663ffffffff9290921691909117921b640100000000600160c01b0316919091179055565b91600185841603612c90575b5050506001600160f81b03198116600160f81b8103612c74575060581c1691823b15610203576122a992600092836040518096819582946306d61fe760e41b845260048401612322565b909350600160f91b141590506103d8576102139160081b613edd565b612c99926136dd565b388080612c2a565b604051633ab3447f60e11b8152600490fd5b9050612cc1612b4487611c53565b90612cd3610775855163ffffffff1690565b9116101538612bcf565b60018452612ba4565b600080516020615130833981519152805463ffffffff60a81b19166001939093019190911660a81b63ffffffff60a81b169190911790553881612b84565b9182358060f81c80600014612d6a5780600114612d5d57600214612d4757600080fd5b6001600160d81b03191692600501916004190190565b5092601501916014190190565b5050600160009301916000190190565b9092608092611e569694835260018060a01b0316602083015260408201528160608201520191611e59565b909192612dc494612db89185858561413d565b94929391969096614231565b509065ffffffffffff8091164210918215612e4a575b5050612e3757612e18612dee602096612e56565b60405163392dffaf60e01b8152978896879586959193916001600160e01b03191660048701612d7a565b03916001600160a01b03165afa90811561091957600091611f3d575090565b506001600160e01b031995945050505050565b16421190503880612dda565b611e569060405160208101917f1547321c374afde8a591d972a084b071c594c275e36724931ff96c25f2999c838352604082015260408152612e9781610ee2565b51902061425a565b90818060081b9160ff839260f01c16600214612eb757565b6001600160d81b031983169150565b9080601f8301121561020357816020611e569335910161263c565b91906101208382031261020357612ef6610f7d565b92612f0081610208565b8452602081013560208501526040810135916001600160401b03928381116102035781612f2e918401612ec6565b604086015260608201358381116102035781612f4b918401612ec6565b60608601526080820135608086015260a082013560a086015260c082013560c086015260e08201358381116102035781612f86918401612ec6565b60e0860152610100928383013590811161020357612fa49201612ec6565b90830152565b90816020910312610203575190565b80516001600160a01b03168252611e569190613037613007612ff561012060208501516020870152604085015190806040880152860190610c78565b60608401518582036060870152610c78565b6080830151608085015260a083015160a085015260c083015160c085015260e083015184820360e0860152610c78565b916101008092015191818403910152610c78565b939291613068906040928652606060208701526060860190612fb9565b930152565b929190613068602091604086526040860190612fb9565b9290926000926130943682612ee1565b9161010091828101916130a78383612003565b90949093600160f81b936001600160f81b031993841685146131f0575b505050871603613151575050604051639700320360e01b8152936020928592839160009183916130f7916004840161306d565b039260581c6001600160a01b03165af190811561091957611e5692600092613120575b50614758565b61314391925060203d60201161314a575b61313b8183610f4f565b810190612faa565b903861311a565b503d613131565b909460081b93909291600160f01b61316e611f87611f8088611e09565b166131de57600061318f6131896020966131b999858a614558565b94614758565b604051630ccab7a160e01b8152979096889586948593926001600160e01b0319166004850161304b565b03926001600160a01b03165af190811561091957611e56926000926131205750614758565b6040516314b9743f60e01b8152600490fd5b9091955061320c939850613205929450612003565b908861436e565b969192909361321f85899599369161263c565b908601523880806130c4565b60008051602061513083398151915280549163ffffffff92600a848260a81c1601908482116132f55782851691851682116132e35760c81c84161015612ca157600080516020615130833981519152805463ffffffff60c81b191660c89290921b63ffffffff60c81b1691909117905554818160c81c1691829160a81c16106132b15750565b600080516020615130833981519152805463ffffffff60a81b191660a89290921b63ffffffff60a81b16919091179055565b60405163e60fd64760e01b8152600490fd5b634e487b7160e01b600052601160045260246000fd5b60405161331781610f18565b600681526512d95c9b995b60d21b60208201529060405161333781610f18565b6005815264302e332e3160d81b602082015290565b60405163d68f602560e01b815233600482015260248101929092526060604483015260648201839052600092839183918290849060849083908084838501378181018301849052601f01601f191681010301926001600160a01b03165af19182156109195780926133bc57505090565b611e5692503d8091833e6109388183610f4f565b600092836133f795936040519687958694859363d68f602560e01b85523360048601611e7a565b03926001600160a01b03165af190811561091957600091613416575090565b611e5691503d806000833e6109388183610f4f565b60009060405192808385378338925af4913d82523d6000602084013e60203d830101604052565b60009192806040519485378338925af4913d82523d6000602084013e60203d830101604052565b6001600160a01b0316803b1561020357604051630b9dfbed60e11b8152602060048201529160009183918290849082906134b7906024830190610c78565b03925af18015610919576134c85750565b61021390610eca565b634e487b7160e01b600052603260045260246000fd5b8051156134f45760200190565b6134d1565b80518210156134f45760209160051b010190565b908210156134f45761027d9160051b810190612003565b96959192939694909460005b86811061354257505050505050509050565b806135838a60019360051b850135613559816102a7565b61356f84613567818c6134f9565b51938c61350d565b9061357b868b8b61350d565b949093612b33565b01613530565b90156134f45790565b6001600160a01b039391929190848316156136d5575b6135b190611dd1565b946135dd6135d06135c28385613589565b356001600160f81b03191690565b6001600160f81b03191690565b946001600160f81b0319808716806136b657505090806135ff92861693611b4c565b823b156102035761362a92600092836040518096819582946306d61fe760e41b845260048401612322565b03925af19485156109195761366661368693600193610213986136a3575b505b82546001600160a01b0319166001600160a01b03909116178255565b0180546001600160a01b0319166001600160a01b03909316929092178255565b805460ff60a01b191660589290921c60ff60a01b16919091179055565b806109136136b092610eca565b38613648565b925092505094919403612a7b576001613686916136666102139661364a565b8492506135a8565b6001600160a01b031691821580156137a0575b61379b5760405163d60b347f60e01b8152306004820152602081602481875afa9081156109195760009161377c575b5015613747576001600160f81b03198061373c6135c28486613589565b161461374757505050565b8061375192611b4c565b823b15610203576122a992600092836040518096819582946306d61fe760e41b845260048401612322565b613795915060203d602011610981576109738183610f4f565b3861371f565b505050565b50600183146136f0565b919392916001600160a01b03908184161561382f575b1660008181526000805160206151108339815191526020526040812080546001600160a01b0319166001600160a01b0390951694909417909355803b1561382b576134b79394836040518096819582946306d61fe760e41b8452602060048501526024840191611e59565b8280fd5b600193506137c0565b7f9d17cd6d095ac90a655405ab29f30a7ee7e88ef3974c1bf7544bf591043bb71a9160609161386a82610bcd83611c8c565b600160ff198254161790556040519163ffffffff60e01b1682526001600160581b031916602082015260016040820152a1565b60407f2b82f87bf66300af618a9621d3f221edfab735f5bacb4e004cce1b62375396c3919392935a8251956138fd876138ef6020820193638a91b0e360e01b8552602060248401526044830190610c78565b03601f198101895288610f4f565b6000918291828587519a6139108c610efd565b828c525193f1943d9081613943575b6020818360009352013e81516001600160a01b0390911681528415156020820152a1565b6000915061391f565b61395c61398f9194939294611dd1565b80546001600160a01b031981168255600190910180546001600160a01b0392831696919492169161273a9136919061263c565b5080546001600160a81b03191660ff60a01b179055565b6001600160a01b0390811660008181526000805160206151108339815191526020526040902080546001600160a01b0319811690915590911693926122b89261273a91369161263c565b90929192613a22613a106000805160206151308339815191525460581b90565b6001600160581b031980851691161490565b6127de57613a32611cfe83611c53565b93613a53613a3f84611c53565b8054640100000000600160c01b0319169055565b6001600160f81b03198316600160f81b8103613a8c57506122b89291613a7a91369161263c565b9060581c6001600160a01b031661389d565b600160f91b141590506103d8576102139160081b6147f3565b604051613ab181610f18565b600181528060005b602080821015613ad457906060602092828501015201613ab9565b50505090565b90613ae482610f8a565b613af16040519182610f4f565b8281528092613b02601f1991610f8a565b019060005b828110613b1357505050565b806060602080938501015201613b07565b906040611e5692600081528160208201520190610c78565b613b50818060081b918160301b9160501b90565b5090936001600160f81b031993600160f81b939092508416838103613bdb575050613b82908035019060208201913590565b929093168015600014613b9a575050611e5691614a71565b03613ba857611e56916149b4565b60405162461bcd60e51b815260206004820152600b60248201526a155b9cdd5c1c1bdc9d195960aa1b6044820152606490fd5b94959490919080613c7d575090613bf191614908565b93909294613bfd613aa5565b971680613c22575050613c0f93614959565b613c18836134e7565b526122b8826134e7565b03613ba857613c3093614930565b613c39846134e7565b52610213577fe723f28f104e46b47fd3531f3608374ac226bcf3ddda334a23a266453e0efdb7613c78613c6b846134e7565b5160405191829182613b24565b0390a1565b919593918203613ba857613cb490613cae613c96613aa5565b9780613ca86123ce6123c88387611b30565b93611b69565b91613452565b613cc0879592956134e7565b5216908103613cfe575015613cd157565b7fe723f28f104e46b47fd3531f3608374ac226bcf3ddda334a23a266453e0efdb7613c78613c6b846134e7565b613ba8576102135760405162461bcd60e51b815260206004820152601360248201527211195b1959d85d1958d85b1b0819985a5b1959606a1b6044820152606490fd5b6001600160a01b03169081158015613d94575b61379b5782156134f4576001600160f81b03198135811614613d7557505050565b82600111610203576122b89261273a913691600019019060010161263c565b5060018214613d54565b600080604092835136810185523683823784516014810186523360601b90528260143601925af1918151913d83523d6000602085013e60203d8401019052565b8054906000906000815582613df257505050565b6000526020600020918201915b828110613e0b57505050565b818155600101613dff565b6001600160501b03199035818116939260168110613e3357505050565b60160360031b82901b16169150565b80548210156134f45760005260206000200190600090565b805468010000000000000000811015610edd57613e7c91600182018155613e42565b819291549060031b9160501c821b9160018060b01b03901b1916179055565b9092809260209483528483013701016000815290565b6001600160f01b03199035818116939260028110613ece57505050565b60020360031b82901b16169150565b90803501906020808301923560fe81118015614135575b61412357600180613f0485611e09565b015461410a575b60001982019260005b84811061402d5750613ff29594614000949093613fd69350613fcf9250613f6f613fc0613fa7611f87613fa1613f9b87878e613f968e613f67611d3b6123ce6123c8613f6189898961350d565b90611b94565b9a8b91611e09565b805462010000600160b01b03191660109290921b62010000600160b01b0316919091179055565b61350d565b90611bc2565b90613eb1565b613fb088611e09565b9060f01c61ffff19825416179055565b6001600160a01b03169661350d565b8091611ba5565b6040519586939092906001600160e01b03191660208501613e9b565b03601f198101845283610f4f565b803b15610203576040516306d61fe760e41b81529160009183918290849082906122a99060048301612102565b614084611d3b611d3b6123ce6123c8613f61868a8e613f968f6140508e91611e09565b0161407e61407161406b61406588888861350d565b90611b86565b90613e16565b6001600160501b03191690565b90613e5a565b90614093613fcf82878b61350d565b906140b4604091613ff283519485928d63ffffffff60e01b168a8501613e9b565b833b156102035760009384926140de92519586809481936306d61fe760e41b835260048301612102565b03925af19182156109195784926140f7575b5001613f14565b8061091361410492610eca565b386140f0565b61411e600161411886611e09565b01613dde565b613f0b565b60405163b62d956d60e01b8152600490fd5b508015613ef4565b84846141c0926141ab97969498956040519161415883610f33565b6141ba60009b8c92838652836020870152604086019d8e52606086019c8d918583528560808901528560a0890152606060c089015260e088019286845261010089019687529063ffffffff60e01b169052565b6001600160a01b039091169052565b52614b0a565b60ff806141d96141d36135c28786613589565b60f81c90565b160361421f576142086141f3846142039561421894611b4c565b9490955163ffffffff60e01b1690565b611e09565b5460101c6001600160a01b031690565b9351929190565b60405163b32eeb6960e01b8152600490fd5b8065ffffffffffff91828160a01c16928315600114614252575b5060d01c92565b92503861424b565b7f00000000000000000000000000000000000000000000000000000000000000007f000000000000000000000000000000000000000000000000000000000000000030147f0000000000000000000000000000000000000000000000000000000000000000461416156142e7575b671901000000000000600052601a52603a526042601820906000603a52565b5060a06040517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f81527f000000000000000000000000000000000000000000000000000000000000000060208201527f00000000000000000000000000000000000000000000000000000000000000006040820152466060820152306080820152206142c8565b9192909261437a61280f565b906143859085611b30565b61438e91612333565b60601c602082018190526000805160206151308339815191525460a81c63ffffffff1680835260349560148082013582018089019791959294919360548601358601808b019490880135939092878c01358801808a013593908d0192918a0135918891908d8436906143ff9261263c565b80519060200120913661441390888861263c565b8051906020012036614426908b8d61263c565b8051602091820120604080517fb17ab1224aca0d4255ef8161acaf2ac121b8faa32a4b2258c912cc5f8308c5059381019384526001600160581b0319989098169088015263ffffffff9390931660608701526001600160a01b0393909316608086015260a085019390935260c084019290925260e080840192909252908252906144b261010082610f4f565b5190206144be9061425a565b607489013589018d8b82013591016144d592614d5c565b9a6144e09488612b33565b6144ea8183614ef9565b6144f391611af4565b6144fc91611c27565b61450591613838565b6094810135019293830192013590565b6001600160c01b0319903581811693926008811061453257505050565b60080360031b82901b16169150565b604090611e56939281528160208201520190612fb9565b60009493916001868161456a85611e09565b016000835b6145b7575b5050505060ff8061458b6141d36135c28789613589565b160361421f576101006145af6145a88561420896611e5698611b4c565b369161263c565b910152611e09565b8197969754811015614750576145e86145e06145d38385613e42565b90549060031b1c60501b90565b908160501c90565b9890976146046145fe6141d36135c28585613589565b60ff1690565b80840361471f575090818161463d61463161462b6146258461465a98611bd0565b90614515565b60c01c90565b6001600160401b031690565b6009019161464f6145a8848484611be1565b6101008b0152611c0f565b989098975b600160f01b1615614674575b5083018361456f565b99866146b1929b60018060a01b036040918983518092633894f6e760e11b8252818b868260209c8d9760049c63ffffffff60e01b168d8401614541565b0393165af1958615610919578896614700575b505084166146e65750506146dc859493928592614758565b9a9192935061466b565b51631f24c1fb60e11b81529081018c815281906020010390fd5b614717929650803d1061314a5761313b8183610f4f565b9338806146c4565b909991989083111561473d57604051630760bdcf60e11b8152600490fd5b6147456125e9565b61010088015261465f565b969596614574565b6001600160a01b03818318811615606083811b848601821b9081149186901b14171760011461478957505050600190565b65ffffffffffff60a01b80831693906001600160d01b0319848116919083169086156147eb575b83811680156147e4575b8781109088180280881897146147dc575b508181119082180218921716171790565b9550386147cb565b50806147ba565b9550856147b0565b9190803501916020906020840193359061480c81611e09565b926001906001850190600182540185036148f657906000835b614888575b505050506148779161487282613fd6610213979861484f6001614118613ff298611e09565b87546148669060101c6001600160a01b0316611d3b565b9460001981019161350d565b61389d565b5080546001600160b01b0319169055565b81548110156148f1579083826148e7613ff28c6148d98a6148be868e6148b66145e06145d38c9f9e8e613e42565b96905061350d565b6040519586939092906001600160e01b0319168c8501613e9b565b6001600160a01b031661389d565b5001909192614825565b61482a565b60405163013dcc8d60e31b8152600490fd5b908060141161020357813560601c928160341161020357601483013592603401916033190190565b906000928491604051958692833738935af1913d82523d6000602084013e60203d830101604052565b9092600092819594604051968792833738935af115614988573d82523d6000602084013e60203d830101604052565b503d6000823e3d90fd5b91908110156134f45760051b81013590605e1981360301821215610203570190565b9190916149c083613ada565b9260005b8181106149d057505050565b806149de6001928486614992565b80356149e9816101f2565b614a0a602080936040936149ff85830183612003565b939092013590614930565b614a14858b6134f9565b5215614a23575b5050016149c4565b7fe723f28f104e46b47fd3531f3608374ac226bcf3ddda334a23a266453e0efdb791614a67614a52858b6134f9565b51838051948594888652850152830190610c78565b0390a13880614a1b565b919091614a7d83613ada565b9260005b818110614a8d57505050565b80614ac36020614aa06001948688614992565b8035614aab816101f2565b614ab86040830183612003565b939092013590614959565b614acd82886134f9565b52614ad881876134f9565b5001614a81565b9092608092611e569594835260018060a01b0316602083015260408201528160608201520190610c78565b9190606083016001936001614b29614203845163ffffffff60e01b1690565b01936000936000958054965b878110614b4757505050505050505050565b80614b596145e06145d38c9486613e42565b6001600160a01b031660a0880190815260808801959091614b82906001600160f01b0319168752565b614b9c614b956141d36135c28a85613589565b60ff168952565b614baa6145fe895160ff1690565b808403614d245750868181614bcf61463161462b614625614c239c9d614bf698611bd0565b60208c018181528c60c0614beb6145a860099586018789611be1565b910152510191611c0f565b959095965b51600160f11b90614c15906001600160f01b031916611f87565b166001600160f01b03191690565b15614c30575b5001614b35565b51909150614c46906001600160a01b0316611d3b565b8651614c6a90614c5d906001600160e01b03191681565b6001600160e01b03191690565b60e08701519091906001600160a01b031691614caf6101008901519360c08a01516040948551808095819463184dfdbb60e11b835260209a8b9760049a8b8601614adf565b03915afa938415610919578b94614d05575b50506001600160a01b038316614cea5750860180518b9392614ce291614758565b905238614c29565b9051631f24c1fb60e11b815290810183815281906020010390fd5b614d1c929450803d1061314a5761313b8183610f4f565b913880614cc1565b839196945010600014614d4357604051630760bdcf60e11b8152600490fd5b614c238b93614d523688612619565b60c08a0152614bfb565b6000805160206151308339815191525460009493929060581b916001600160f81b03198316600160f81b8103614e1f5750604051637aa8f17760e11b8152936020938593909284928392614db4923060048601611e7a565b039160581c6001600160a01b03165afa90811561091957600091614e00575b505b6001600160e01b0319166374eca2c160e11b01614dee57565b6040516362467c7760e11b8152600490fd5b614e19915060203d602011611f5f57611f578183610f4f565b38614dd3565b919550929190600160f91b036103d857602091614e429160081b9584308861413d565b60405163392dffaf60e01b81529297929586949385938493614e7593909230906001600160e01b03191660048701612d7a565b03916001600160a01b03165afa90811561091957600091614e97575b50614dd5565b614eb0915060203d602011611f5f57611f578183610f4f565b38614e91565b15614ebd57565b60405162461bcd60e51b8152602060048201526014602482015273496e76616c69642073656c6563746f724461746160601b6044820152606490fd5b614f066106528383611af4565b906004831015614f1557505050565b602c83106150a557614f30611d3b6123ce6123c88685611b1f565b602c8201358201602c604c820191013591604c840135840194614f6a614f5c6135d06135c28787613589565b6001600160f81b0319161590565b80615014575b94614fb161251795611d3b95614fb6956102139b956123ce9a614fc6575b614fa1611d3b6123ce6123c88a8a611bfe565b916001600160a01b031690613592565b611bfe565b602c86013595604c019491612333565b61500f606c8701358701615009602c604c830192013580614ff0611d3b6123ce6123c88488611b30565b93615004856001600160a01b038a166150b3565b611b69565b916136dd565b614f8e565b5091939092956040519163ecd0596160e01b83526020838061503e60048201906002602083019252565b03816001600160a01b0389165afa92831561091957610213986123ce9761251797611d3b97614fb697614fb195600091615086575b50959a50959b5095509550955050614f70565b61509f915060203d602011610981576109738183610f4f565b38615073565b505060046102139114614eb6565b61021391906001600160a01b039081831615615106575b1660005260008051602061511083398151915260205260406000209060018060a01b03166bffffffffffffffffffffffff60a01b825416179055565b600192506150ca56fe1bbee3173dbdc223633258c9f337a0fff8115f206d302bea0ed3eac003b68b867bcaa2ced2a71450ed5a9a1b4848e8e5206dbc3f06011e595f7f55428cc6f84f0000000000000000000000000000000071727de22e5e9d8baf0edac6f37da032";

bytes constant STAKER_CODE =
    hex"0000000000000000000000000000000000000000000000000000000000000000608060405234801561001057600080fd5b5060405161080838038061080883398101604081905261002f9161007a565b6100388161003e565b506100aa565b6001600160a01b0316638b78c6d8198190558060007f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08180a350565b60006020828403121561008c57600080fd5b81516001600160a01b03811681146100a357600080fd5b9392505050565b61074f806100b96000396000f3fe6080604052600436106100c25760003560e01c8063b36f97051161007f578063d8b964e611610059578063d8b964e614610172578063f04e283e146101b2578063f2fde38b146101c5578063fee81cf4146101d857600080fd5b8063b36f970514610139578063c5265d5d1461014c578063c7e55f3e1461015f57600080fd5b806325692962146100c75780634a1ce599146100d157806354d1f13d146100e45780636e7dbabb146100ec578063715018a6146100ff5780638da5cb5b14610107575b600080fd5b6100cf610219565b005b6100cf6100df3660046105a7565b610269565b6100cf6102c7565b6100cf6100fa3660046105cb565b610303565b6100cf610336565b34801561011357600080fd5b50638b78c6d819545b6040516001600160a01b0390911681526020015b60405180910390f35b6100cf610147366004610609565b61034a565b61011c61015a366004610637565b6103b1565b6100cf61016d3660046106c2565b610466565b34801561017e57600080fd5b506101a261018d3660046105a7565b60006020819052908152604090205460ff1681565b6040519015158152602001610130565b6100cf6101c03660046105a7565b6104d2565b6100cf6101d33660046105a7565b610512565b3480156101e457600080fd5b5061020b6101f33660046105a7565b63389a75e1600c908152600091909152602090205490565b604051908152602001610130565b60006202a30067ffffffffffffffff164201905063389a75e1600c5233600052806020600c2055337fdbf36a107da19e49527a7176a1babf963b4b0ff8cde35ee35d6cd8f1f9ac7e1d600080a250565b610271610539565b806001600160a01b031663bb9fe6bf6040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156102ac57600080fd5b505af11580156102c0573d6000803e3d6000fd5b5050505050565b63389a75e1600c523360005260006020600c2055337ffa7b8eab7da67f412cc9575ed43464468f9bfbae89d1675917346ca6d8fe3c92600080a2565b61030b610539565b6001600160a01b03919091166000908152602081905260409020805460ff1916911515919091179055565b61033e610539565b6103486000610554565b565b610352610539565b60405163611d2e7560e11b81526001600160a01b03828116600483015283169063c23a5cea90602401600060405180830381600087803b15801561039557600080fd5b505af11580156103a9573d6000803e3d6000fd5b505050505050565b6001600160a01b03841660009081526020819052604081205460ff166103ea57604051633220d5f360e21b815260040160405180910390fd5b604051633a9b44eb60e21b81526001600160a01b0386169063ea6d13ac9061041a908790879087906004016106f9565b6020604051808303816000875af1158015610439573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061045d9190610732565b95945050505050565b61046e610539565b604051621cb65b60e51b815263ffffffff821660048201526001600160a01b03831690630396cb609034906024016000604051808303818588803b1580156104b557600080fd5b505af11580156104c9573d6000803e3d6000fd5b50505050505050565b6104da610539565b63389a75e1600c52806000526020600c20805442111561050257636f5e88186000526004601cfd5b6000905561050f81610554565b50565b61051a610539565b8060601b61053057637448fbae6000526004601cfd5b61050f81610554565b638b78c6d819543314610348576382b429006000526004601cfd5b638b78c6d81980546001600160a01b039092169182907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0600080a355565b6001600160a01b038116811461050f57600080fd5b6000602082840312156105b957600080fd5b81356105c481610592565b9392505050565b600080604083850312156105de57600080fd5b82356105e981610592565b9150602083013580151581146105fe57600080fd5b809150509250929050565b6000806040838503121561061c57600080fd5b823561062781610592565b915060208301356105fe81610592565b6000806000806060858703121561064d57600080fd5b843561065881610592565b9350602085013567ffffffffffffffff8082111561067557600080fd5b818701915087601f83011261068957600080fd5b81358181111561069857600080fd5b8860208285010111156106aa57600080fd5b95986020929092019750949560400135945092505050565b600080604083850312156106d557600080fd5b82356106e081610592565b9150602083013563ffffffff811681146105fe57600080fd5b604081528260408201528284606083013760006060848301015260006060601f19601f8601168301019050826020830152949350505050565b60006020828403121561074457600080fd5b81516105c481610592560000000000000000000000009775137314fe595c943712b0b336327dfa80ae8a";

bytes constant KERNEL_FACTORY_CODE =
    hex"000000000000000000000000000000000000000000000000000000000000000060a034607357601f61046c38819003918201601f19168301916001600160401b03831184841017607857808492602094604052833981010312607357516001600160a01b03811681036073576080526040516103dd908161008f823960805181818160d10152818161023401526102f00152f35b600080fd5b634e487b7160e01b600052604160045260246000fdfe60806040818152600490600436101561001757600080fd5b600092833560e01c90816348aac39214610267575080635c60da1b1461021f5763ea6d13ac1461004657600080fd5b61004f36610352565b94919083519560209661007a86828a81019486888737868201908c820152038a8101845201826103a5565b5190209483958551917fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f36060527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e2076875261600989527f0000000000000000000000000000000000000000000000000000000000000000601e5268603d3d8160223d3973600a52605f97602192605f60212060358601523060581b855260ff855380601586015260558520993415948b3b156101fe57505050506001916101f85785388180348c5af1156101ed57505b818652846060521561016b575b505091516001600160a01b0390931683525050f35b8082859493859483378101838152039082875af1903d156101e7573d9067ffffffffffffffff82116101d3578351916101ad601f8201601f19168801846103a5565b8252853d92013e5b156101c35738808080610156565b5163487e630960e11b8152600490fd5b634e487b7160e01b81526041600452602490fd5b506101b5565b63b12d13eb8652601cfd5b50610149565b91939a5091935034f59687156102145750610149565b63301164258652601cfd5b838234610263578160031936011261026357517f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03168152602090f35b5080fd5b848334610263578260209361029d8361027f36610352565b90808a879498019788378201908982015203878101845201826103a5565b51902081517fcc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f36060527f5155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e2076835261600985527f0000000000000000000000000000000000000000000000000000000000000000601e5268603d3d8160223d3973600a52605f6021209083528360605260ff84536035523060601b6001526015526055822091603552519060018060a01b03168152f35b9060406003198301126103a05760043567ffffffffffffffff928382116103a057806023830112156103a05781600401359384116103a057602484830101116103a057602401919060243590565b600080fd5b90601f8019910116810190811067ffffffffffffffff8211176103c757604052565b634e487b7160e01b600052604160045260246000fd000000000000000000000000ec9aa3a41d6baf3cdb2268ef7a8b116ea74925ef";

contract Deploy is Script {
    address constant DEPLOYER = 0x9775137314fE595c943712B0b336327dfa80aE8A;
    address constant ENTRYPOINT_0_7_ADDR = 0x0000000071727De22E5E9d8BAf0edAc6f37da032;
    address constant CREATE2_PROXY = 0x4e59b44847b379578588920cA78FbF26c0B4956C;

    address constant EXPECTED_STAKER = 0xd703aaE79538628d27099B8c4f621bE4CCd142d5;
    address constant EXPECTED_KERNEL = 0xec9aA3A41D6bAf3cDb2268ef7a8B116EA74925Ef;
    address constant EXPECTED_FACTORY = 0xB52f3C04AeAF9364FBf68310a8128aabb40C9ABb;

    function run() external {
        vm.startBroadcast(DEPLOYER);
        FactoryStaker staker = FactoryStaker(payable(EXPECTED_STAKER));
        if (address(staker).code.length == 0) {
            (bool success,) = CREATE2_PROXY.call(STAKER_CODE);
            require(success);
            console.log("Deployed staker");
        }
        console.log("Factory Staker :", address(staker));

        Kernel kernel = Kernel(payable(EXPECTED_KERNEL));
        if (EXPECTED_KERNEL.code.length == 0) {
            (bool success,) = CREATE2_PROXY.call(KERNEL_CODE);
            require(success);
            console.log("Deployed kernel");
        }
        console.log("Kernel :", address(kernel));

        KernelFactory factory = KernelFactory(EXPECTED_FACTORY);
        if (EXPECTED_FACTORY.code.length == 0) {
            (bool success,) = CREATE2_PROXY.call(KERNEL_FACTORY_CODE);
            require(success);
            console.log("Deployed factory");
        }
        console.log("Factory :", address(factory));

        if (!staker.approved(factory)) {
            staker.approveFactory(factory, true);
            console.log("Approved");
        }
        IEntryPoint entryPoint = IEntryPoint(ENTRYPOINT_0_7_ADDR);
        IStakeManager.DepositInfo memory info = entryPoint.getDepositInfo(address(staker));
        if (info.stake < 1e17) {
            staker.stake{value: 1e17 - info.stake}(IEntryPoint(ENTRYPOINT_0_7_ADDR), 86400);
        }
        vm.stopBroadcast();
    }
}
